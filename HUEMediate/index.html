<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Hue Immediate</title>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
    <meta name='viewport' content='width=device-width' />

    <meta name='mobile-web-app-capable' content='yes' />
    <meta name='mobile-web-app-title' content='Hue Immediate' />
    <meta name='apple-mobile-web-app-title' content='Hue Immediate' />
    <meta name='apple-mobile-web-app-capable' content='yes' />
    <meta name='apple-mobile-web-app-status-bar-style' content='black' />

    <script src='http://code.jquery.com/jquery-1.10.2.min.js' type='text/javascript' ></script>
    <script src='http://code.jquery.com/mobile/1.4.0/jquery.mobile-1.4.0.min.js' type='text/javascript' ></script>
    <link rel='stylesheet' href='http://code.jquery.com/mobile/1.4.0/jquery.mobile-1.4.0.min.css'/>

    <script src='../HUEPI.js' type='text/javascript'></script>

    <style type='text/css'>
      html, body, .ui-mobile, .ui-mobile-viewport, .ui-page {
        width: 100%;
        height: 100%;
        background:#000000;
        border: 0px;
        color: #ffffff;
      }
      .ui-mobile, .ui-mobile-viewport, .ui-page {
        height: 75%; // removing scrollbar
      }
      .page {
        width: 100%;
        height: 90%; // removing scrollbar
      }
      .container {
        margin-top: 15px;
        width: 50%;
        height: 100%;
        float: left;
        display: table;
      }
      .content {
        display: table-cell;
        text-align: center;
        vertical-align: middle;
      }
      .items {
      }
      .ui-footer {
        float: bottom;
        background: #000000;
        border: 0px;
        color: #ffffff;
        position: fixed;
        width: 100%;
        z-index: 999;
      }
      .ui-slider-track {
        margin-left: 15px;
        max-width: 320px;
      }
      #feetupbutton,
      #relaxbutton, #energizebutton, #concentratebutton, #readingbutton,
      #onbutton, #offbutton {
        min-width: 64px;
        max-width: 128px;
      }
    </style>
  </head>
  <body>
    <script type='text/javascript' >
      var MyHue = new HUEPI();

      $(document).ready(function() {
        var HueImage = new Image();
        HueImage.src = 'images/HUE.png';

        function HueImageRedraw()
        {
          var HueCanvas = document.getElementById('HUECanvas');
          var HueContext = document.getElementById('HUECanvas').getContext('2d');
          //HueCanvas.width = 0.7 * (Math.min($(window).width(), $(window).height()));
          HueCanvas.height = HueCanvas.width;
          HueContext.drawImage(HueImage, 0, 0, HueCanvas.width, HueCanvas.height);
        }

        HueImage.onload = function() {
          window.onresize();
        };

        window.onresize = function() {
          // ReAlign #HueButtons & #HueDirect
          if ($(window).width() > $(window).height()) { // Landscape
            $(".container").css("height", "100%");
            document.getElementById('HueButtons').style.width = "50%";
            document.getElementById('HueDirect').style.width = "50%";
            document.getElementById('HUECanvas').width = 0.45 * $(window).width();
          } else { // Portrait
            $(".container").css("height", "0");
            document.getElementById('HueButtons').style.width = "100%";
            document.getElementById('HueDirect').style.width = "100%";
            document.getElementById('HUECanvas').width = 0.7 * $(window).width();
          }
          HueImageRedraw();
        };

        $('#HUECanvas').bind('mousedown', function HUECanvasMouseDown(event) {
          var x = event.offsetX;//event.pageX - event.currentTarget.offsetLeft;
          var y = event.offsetY;//event.pageY - event.currentTarget.offsetTop;
          var HueContext = document.getElementById('HUECanvas').getContext('2d');
          var HueImagedata = HueContext.getImageData(x, y, 1, 1); // one Pixel at Cursor
          var HueImagePixel = HueImagedata.data; // data[] RGB of Pixel
          MyHue.GroupSetRGB(0, HueImagePixel[0], HueImagePixel[1], HueImagePixel[2]);
        });

        $('#brightnessslider').on('slidestop', function(event, ui) {
          var Brightness = parseInt($(this).val());
          MyHue.GroupSetBrightness(0, Brightness);
        });

        DiscoverBridgeAndTryWhitelisting();
      });

      // look for bridge
      // wait for BridgeName
      // check if UsernameWhitelisted
      //   NO? -> whitelist
      // play
      function DiscoverBridgeAndTryWhitelisting()
      {
        MyHue.Username = '085efe879ee3ed83c04efc28a0da03d3';

        if (!localStorage.HUEPIBridgeIP) { // Cached BridgeIP
          $('#HUEStatus').text('Trying to Discover HUE Bridge via HUE Portal');
          MyHue.PortalDiscoverLocalBridges().then(function GetBridgeConfig() {
            MyHue.BridgeGet().then(function EnsureWhitelisting() {
              $('#HUEBridgeIP').text('Bridge IP: ' + MyHue.BridgeIP);
              if (!MyHue.UsernameWhitelisted) {
                $('#HUEStatus').text('Please press connect button on the Hue Bridge');
                MyHue.BridgeCreateUser().then(function ReReadBridgeConfiguration() {
                  setTimeout(GetBridgeConfig, 1000);
                }, function UnableToCreateUseronBridge() {
                  $('#HUEStatus').text('Unable to Create User on Bridge');
                });
              } else {
                $('#HUEBridgeName').text('Bridge Name: ' + MyHue.BridgeName);
                $('#HUEStatus').text('Found Bridge and Whitelisted, so able to Set Lights and Groups');
                $('#HUEInfoBar').hide('slow');
                MyHue.GroupOn(0);
                MyHue.GroupEffectNone(0);
                localStorage.HUEPIBridgeIP = MyHue.BridgeIP; // Cache BridgeIP
                StatusHeartbeat();
              }
            }, function UnableToRetreiveBridgeConfiguration() {
              $('#HUEStatus').text('Unable to Retreive Bridge Configuration');
            });
          }, function UnableToDiscoverLocalBridgesViaPortal() {
            $('#HUEStatus').text('Unable to find Local Bridge via Portal');
          });
        } else
        {
          MyHue.BridgeIP = localStorage.HUEPIBridgeIP;
          $('#HUEBridgeIP').text('Cached Bridge IP: ' + MyHue.BridgeIP);
          MyHue.BridgeGet().then(function CheckWhitelisting() {
            if (MyHue.UsernameWhitelisted) {
              $('#HUEBridgeName').text('Bridge Name: ' + MyHue.BridgeName);
              $('#HUEStatus').text('Found Bridge again and Whitelisted, so able to Set Lights and Groups');
              $('#HUEInfoBar').hide('slow');
              MyHue.GroupOn(0);
              MyHue.GroupEffectNone(0);
              StatusHeartbeat();
            } else {
              delete localStorage.HUEPIBridgeIP;
              return DiscoverBridgeAndTryWhitelisting();
            }
          }).fail(function FailedToFindBridgeAtCachedBridgeIP() {
            delete localStorage.HUEPIBridgeIP;
            return DiscoverBridgeAndTryWhitelisting();
          });
        }
      }

      function StatusHeartbeat() {
        MyHue.BridgeGet().then(function UpdateUI() {
          $('#brightnessslider').val(MyHue.Lights[1].state.bri); // Get 1st light brightness for now...
          $('#brightnessslider').slider('refresh');
          setTimeout(StatusHeartbeat, 2500);
        }, function BridgetHeartbeatGetFailed() {
          $('#HUEStatus').text('StatusHeartbeat BridgeGet Failed');
          $('#HUEInfoBar').show('slow');
        });
      }
    </script>
    <div class='page'>

      <div class='container' id='HueButtons'>
        <div class='content'>
          <div class='items' align='center'>
            <a href='#' data-role='button' data-icon='' data-mini='true' id='feetupbutton' onclick='JavaScript:MyHue.GroupSetHSB(1, 7000, 207, 207)'>Feet Up</a>
            <div min-width='128'>
              <input style='display:none' data-mini='false' type='range' name='brightnessslider' id='brightnessslider' min='0' max='255' value='140' />
            </div>
            <div>
              <a href='#' id='relaxbutton' data-role='button' data-icon='' data-inline='true' data-mini='true' onclick='JavaScript:MyHue.GroupSetCT(0, 467);
                  MyHue.GroupSetBrightness(0, 144)'>Relax</a>
              <a href='#' id='energizebutton' data-role='button' data-icon='' data-inline='true' data-mini='true' onclick='JavaScript:MyHue.GroupSetCT(0, 156);
                  MyHue.GroupSetBrightness(0, 203)'>Energize</a>
              <a href='#' id='concentratebutton' data-role='button' data-icon='' data-inline='true' data-mini='true' onclick='JavaScript:MyHue.GroupSetCT(0, 231);
                  MyHue.GroupSetBrightness(0, 219)'>Concentrate</a>
              <a href='#' id='readingbutton' data-role='button' data-icon='' data-inline='true' data-mini='true' onclick='JavaScript:MyHue.GroupSetCT(0, 343);
                  MyHue.GroupSetBrightness(0, 240)'>Reading</a>
            </div>
          </div>
        </div><!-- /group -->
      </div><!-- /container -->

      <div class='container' id='HueDirect'>
        <div class='content'>
          <div class='items'>
            <canvas id='HUECanvas' width=320 height=320 >It seems your device doesn't support the required HTML5 Canvas</canvas>
          </div>
        </div><!-- /group -->
      </div><!-- /container -->

      <div data-role='footer'  align='center' data-id='navigation' data-position='fixed'>
        <div data-role='controlgroup' data-type='horizontal'>
          <a href='#' id='offbutton' data-role='button' data-icon='' data-inline='false' class='ui-btn ui-btn-b' data-mini='true' onclick='JavaScript:MyHue.GroupOff(0)'>All Off</a>
          <a href='#' id='onbutton' data-role='button' data-icon='' data-inline='false' class='ui-btn ui-btn-d' data-mini='true' onclick='JavaScript:MyHue.GroupOn(0)'>All On</a>
        </div>
        <div id='HUEInfoBar'>
          <div id='HUEBridgeIP'>
            Bridge IP: . . .
          </div>
          <div id='HUEBridgeName'>
            Bridge Name: . . .
          </div>
          <div id='HUEStatus'>
            Status . . . .
          </div>
        </div>
      </div><!-- /footer -->

    </div><!-- /page -->
  </body>
</html>
