<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Hue Immediate</title>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
    <meta name='viewport' content='width=device-width' />

    <meta name='mobile-web-app-capable' content='yes' />
    <meta name='mobile-web-app-title' content='Hue Immediate' />
    <meta name='apple-mobile-web-app-title' content='Hue Immediate' />
    <meta name='apple-mobile-web-app-capable' content='yes' />
    <meta name='apple-mobile-web-app-status-bar-style' content='black' />

    <script src='http://code.jquery.com/jquery-1.10.2.min.js' type='text/javascript' ></script>
    <script src='http://code.jquery.com/mobile/1.4.0/jquery.mobile-1.4.0.min.js' type='text/javascript' ></script>
    <link rel='stylesheet' href='http://code.jquery.com/mobile/1.4.0/jquery.mobile-1.4.0.min.css'/>

    <script src='../HUEPI.js' type='text/javascript'></script>

    <style type='text/css'>
      html, body, .page, .ui-mobile, .ui-mobile-viewport, .ui-page {
        width: 100%;
        height: 100%;
        background:#000000;
        border: 0px;
        color: #ffffff;
        text-shadow: 0px 0px;
      }
      .container {
        float: left;
        display: table;
        width: 50%;
        height: 50%;
        margin-top: 0px;
        text-align: center;
      }
      @media screen and (orientation:portrait) {
        .container {
          width: 100%;
          height: 50%;
          margin-top: 00px;
        }
      }
      @media screen and (orientation:landscape) {
        .container {
          width: 50%;
          height: 100%;
          margin-top: -00px;
        }
      }
      .content {
        display: table-cell;
        text-align: center;
        vertical-align: middle;
      }
      .items {
      }
      .ui-slider-track {
        margin-left: 15px;
        max-width: 320px;
      }
      #feetupbutton,
      #relaxbutton, #energizebutton, #concentratebutton, #readingbutton,
      #onbutton, #offbutton {
        min-width: 96px;
        max-width: 128px;
      }
      .footer {
        position: fixed;
        left: 0px;
        bottom: 0px;
        height: auto;
        width: 100%;
        text-align: center;
        background: #f6f6f6;
        color: #000000;
      }
    </style>
  </head>
  <body>
    <script type='text/javascript' >

      var MyHue = new HUEPI();
      MyHue.Username = '085efe879ee3ed83c04efc28a0da03d3';

      $(document).ready(function InitialStartup() {
        var HueImage = new Image();
        HueImage.src = 'images/HUE.png';

        function HueImageRedraw()
        {
          var HueCanvas = document.getElementById('HUECanvas');
          var HueContext = document.getElementById('HUECanvas').getContext('2d');
          //HueCanvas.width = 0.7 * (Math.min($(window).width(), $(window).height()));
          HueCanvas.height = HueCanvas.width;
          HueContext.drawImage(HueImage, 0, 0, HueCanvas.width, HueCanvas.height);
        }

        HueImage.onload = function() {
          window.onresize();
        };

        window.onresize = function() {
          // Canvas should be set by script not css, otherwise getting HueImagePixel doesn't match canvas sizes
          if ($(window).width() > $(window).height()) { // Landscape
            document.getElementById('HUECanvas').width = 0.45 * $(window).width();
          } else { // Portrait
            document.getElementById('HUECanvas').width = 0.45 * $(window).height();
          }
          HueImageRedraw();
        };

        $("#HUECanvas").click(function(event) {
          var x = event.pageX - event.currentTarget.offsetLeft;
          var y = event.pageY - event.currentTarget.offsetTop;
          var HueContext = document.getElementById('HUECanvas').getContext('2d');
          var HueImagedata = HueContext.getImageData(x, y, 1, 1); // one Pixel at Cursor
          var HueImagePixel = HueImagedata.data; // data[] RGB of Pixel
          MyHue.GroupSetRGB(0, HueImagePixel[0], HueImagePixel[1], HueImagePixel[2]);
        });

        $('#brightnessslider').on('slidestop', function(event, ui) {
          var Brightness = parseInt($(this).val());
          MyHue.GroupSetBrightness(0, Brightness);
        });

        DiscoverBridgeAndTryWhitelisting();
      });

      // look for bridge
      // wait for BridgeName
      // check if BridgeUsernameWhitelisted
      //   NO? -> whitelist
      // play
      function DiscoverBridgeAndTryWhitelisting()
      {
        if (!localStorage.HUEPIBridgeIP) { // No Cached BridgeIP?
          $('#HUEStatus').text('Trying to Discover HUE Bridge via HUE Portal');
          MyHue.PortalDiscoverLocalBridges().then(function GetBridgeConfig() {
            MyHue.BridgeGetData().then(function EnsureWhitelisting() {
              $('#HUEBridgeIP').text('Bridge IP: ' + MyHue.BridgeIP);
              if (!MyHue.BridgeUsernameWhitelisted) {
                $('#HUEStatus').text('Please press connect button on the Hue Bridge');
                MyHue.BridgeCreateUser().then(function ReReadBridgeConfiguration() {
                  return setTimeout(GetBridgeConfig, 1000);
                }, function UnableToCreateUseronBridge() {
                  $('#HUEStatus').text('Unable to Create User on Bridge');
                });
              } else {
                LightsOnAndStartHeartbeat();
              }
            }, function UnableToRetreiveBridgeConfiguration() {
              $('#HUEStatus').text('Unable to Retreive Bridge Configuration');
            });
          }, function UnableToDiscoverLocalBridgesViaPortal() {
            $('#HUEStatus').text('Unable to find Local Bridge via Portal');
          });
        } else
        {
          MyHue.BridgeIP = localStorage.HUEPIBridgeIP;
          $('#HUEBridgeIP').text('Cached Bridge IP: ' + MyHue.BridgeIP);
          MyHue.BridgeGetData().then(function CheckWhitelisting() {
            if (MyHue.BridgeUsernameWhitelisted) {
              return LightsOnAndStartHeartbeat();
            }
          });
          delete localStorage.HUEPIBridgeIP; // Not Found again, or not Whitelisted (anymore)
          return DiscoverBridgeAndTryWhitelisting();
        }
      }

      function LightsOnAndStartHeartbeat() {
        localStorage.HUEPIBridgeIP = MyHue.BridgeIP; // Restore Cache BridgeIP
        $('#HUEBridgeName').text('Bridge Name: ' + MyHue.BridgeName);
        $('#HUEStatus').text('Found Bridge and Whitelisted, so able to Set Lights and Groups');
        $('#HUEInfoBar').slideUp(2500);
        MyHue.GroupOn(0);
        MyHue.GroupEffectNone(0);
        StatusHeartbeat();
      }

      function StatusHeartbeat() {
        MyHue.BridgeGetData().then(function UpdateUI() {
          $('#brightnessslider').val(MyHue.Lights[1].state.bri); // Get 1st light brightness for now...
          $('#brightnessslider').slider('refresh');
          setTimeout(StatusHeartbeat, 2500);
        }, function BridgetHeartbeatGetFailed() {
          $('#HUEStatus').text('StatusHeartbeat BridgeGet Failed');
          $('#HUEInfoBar').show(1500);
          DiscoverBridgeAndTryWhitelisting();
        });
      }
    </script>
    <div class='page'>

      <div class='container' id='HueDirect'>
        <div class='content'>
          <div class='items'>
            <canvas id='HUECanvas' width=32 height=32 >It seems your device doesn't support the required HTML5 Canvas</canvas>
          </div>
        </div><!-- /group -->
      </div><!-- /container -->

      <div class='container' id='HueButtons'>
        <div class='content'>
          <div class='items' align='center'>
            <a href='#' data-role='button' data-icon='' data-mini='true' id='feetupbutton' onclick='JavaScript:MyHue.GroupSetHSB(1, 7000, 207, 207)'>Feet Up</a>
            <div min-width='128'>
              <input style='display:none' data-mini='false' type='range' name='brightnessslider' id='brightnessslider' min='0' max='255' value='140' />
            </div>
            <div>
              <a href='#' id='relaxbutton' data-role='button' data-icon='' data-inline='true' data-mini='true' onclick='JavaScript:MyHue.GroupSetCT(0, 467);
                  MyHue.GroupSetBrightness(0, 144)'>Relax</a>
              <a href='#' id='energizebutton' data-role='button' data-icon='' data-inline='true' data-mini='true' onclick='JavaScript:MyHue.GroupSetCT(0, 156);
                  MyHue.GroupSetBrightness(0, 203)'>Energize</a>
              <a href='#' id='concentratebutton' data-role='button' data-icon='' data-inline='true' data-mini='true' onclick='JavaScript:MyHue.GroupSetCT(0, 231);
                  MyHue.GroupSetBrightness(0, 219)'>Concentrate</a>
              <a href='#' id='readingbutton' data-role='button' data-icon='' data-inline='true' data-mini='true' onclick='JavaScript:MyHue.GroupSetCT(0, 343);
                  MyHue.GroupSetBrightness(0, 240)'>Reading</a>
            </div>
          </div>
        </div><!-- /group -->
      </div><!-- /container -->

      <div class='footer'>
        <div data-role='controlgroup' data-type='horizontal' data-inline='true' data-mini='true' >
          <a href='#' id='onbutton' data-role='button' data-icon='' data-inline='false' class='ui-btn ui-btn-d' data-mini='true' onclick='JavaScript:MyHue.GroupOn(0)'>All On</a>
          <a href='#' id='offbutton' data-role='button' data-icon='' data-inline='false' class='ui-btn ui-btn-b' data-mini='true' onclick='JavaScript:MyHue.GroupOff(0)'>All Off</a>
        </div>
        <div id='HUEInfoBar'>
          <div id='HUEBridgeIP'>
            Bridge IP: . . .
          </div>
          <div id='HUEBridgeName'>
            Bridge Name: . . .
          </div>
          <div id='HUEStatus'>
            Status . . . .
          </div>
        </div>
      </div><!-- /footer -->

    </div><!-- /page -->
  </body>
</html>
